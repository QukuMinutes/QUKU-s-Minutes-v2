<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUKU's Minutes v2</title>
    <style>
        :root {
            --bg-color: #111827;
            --panel-bg-color: #1F2937;
            --text-color: #E2E8F0;
            --accent-color: #A78BFA;
            --border-color: #374151;
            --success-color: #22C55E;
            --error-color: #EF4444;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color-scheme: dark;
        }
        body { background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
        h1 { display: flex; align-items: center; gap: 12px; }
        .status-light { width: 12px; height: 12px; border-radius: 50%; background-color: var(--border-color); transition: background-color 0.5s; }
        .status-light.connected { background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .status-light.error { background-color: var(--error-color); box-shadow: 0 0 8px var(--error-color); }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 600; font-size: 0.9rem; color: #9CA3AF; }
        select, textarea, button { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--panel-bg-color); color: var(--text-color); font-size: 1rem; font-family: inherit; }
        textarea { min-height: 250px; resize: vertical; }
        button { cursor: pointer; background-color: var(--accent-color); font-weight: bold; border: none; transition: background-color 0.2s, opacity 0.2s; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .copy-button { background-color: var(--border-color); }
        .progress-bar-container { width: 100%; height: 6px; background-color: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 16px; display: none; }
        .progress-bar { height: 100%; width: 0; background-color: var(--accent-color); transition: width 1s ease; }
        .message-area { padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; display: none; }
        .message-area.success { background-color: rgba(34, 197, 94, 0.2); color: var(--success-color); }
        .message-area.error { background-color: rgba(239, 68, 68, 0.2); color: var(--error-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span id="status-light" class="status-light"></span>
            <span>QUKU's Minutes v2 (Supabase)</span>
        </h1>

        <div id="message-area" class="message-area"></div>

        <div class="form-group">
            <label for="project-selector">1. プロジェクトを選択</label>
            <select id="project-selector" disabled>
                <option value="">データベースに接続中...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="log-content-input">2. 今回の全ログ（ここにペースト）</label>
            <textarea id="log-content-input" placeholder="議事録ツールなどから、今回の会話ログ全体をここに貼り付けてください。"></textarea>
        </div>

        <div class="form-group">
            <button id="save-log-btn">3. このログをDBに記録する</button>
        </div>

        <div class="progress-bar-container" id="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="form-group">
            <label for="all-logs-output">4. AIへの状況共有用（全ログ）</label>
            <button id="fetch-all-logs-btn">選択中プロジェクトの全ログを取得</button>
            <textarea id="all-logs-output" readonly style="margin-top: 10px; min-height: 300px;"></textarea>
            <button id="copy-all-logs-btn" class="copy-button">全ログをコピー</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 要素取得 ---
        const statusLight = document.getElementById('status-light');
        const projectSelector = document.getElementById('project-selector');
        const logContentInput = document.getElementById('log-content-input');
        const saveLogBtn = document.getElementById('save-log-btn');
        const fetchAllLogsBtn = document.getElementById('fetch-all-logs-btn');
        const allLogsOutput = document.getElementById('all-logs-output');
        const copyAllLogsBtn = document.getElementById('copy-all-logs-btn');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const messageArea = document.getElementById('message-area');

        // --- メッセージ表示ヘルパー ---
        const showMessage = (type, text, duration = 4000) => {
            messageArea.className = `message-area ${type}`;
            messageArea.textContent = text;
            messageArea.style.display = 'block';
            if (duration) {
                setTimeout(() => { messageArea.style.display = 'none'; }, duration);
            }
        };

        // --- プログレスバー管理 ---
        const startProgress = () => {
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            progressBarContainer.style.display = 'block';
            setTimeout(() => {
                progressBar.style.transition = 'width 10s cubic-bezier(0.4, 0, 0.2, 1)';
                progressBar.style.width = '95%';
            }, 50);
        };
        const finishProgress = () => {
            progressBar.style.transition = 'width 0.3s ease-out';
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBarContainer.style.display = 'none';
            }, 500);
        };
        
        // --- プロジェクト初期化 ---
        const initializeProjects = async () => {
            try {
                // APIを叩いてプロジェクト一覧を取得
                const response = await fetch('/api/get-projects');
                if (!response.ok) throw new Error(`サーバーからの応答が不正です: ${response.status}`);
                const projects = await response.json();

                projectSelector.innerHTML = ''; // ローディング表示をクリア
                
                if (projects.length === 0) {
                    projectSelector.innerHTML = `<option value="">プロジェクトがありません</option>`;
                    showMessage('error', 'Supabaseにプロジェクトが登録されていません。先にSupabase側でプロジェクトを登録してください。', null);
                    return;
                }

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'プロジェクトを選択してください';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                projectSelector.appendChild(defaultOption);

                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id; // valueにはIDを設定
                    option.textContent = project.project_name; // 表示はプロジェクト名
                    projectSelector.appendChild(option);
                });

                projectSelector.disabled = false;
                statusLight.classList.add('connected');

            } catch (error) {
                console.error('プロジェクトの読み込みに失敗:', error);
                projectSelector.innerHTML = `<option value="">読み込み失敗...</option>`;
                statusLight.classList.add('error');
                showMessage('error', `プロジェクトの読み込みに失敗しました: ${error.message}`, null);
            }
        };

        // --- ログ保存ボタン ---
        saveLogBtn.addEventListener('click', async () => {
            const projectId = projectSelector.value;
            const logContent = logContentInput.value.trim();

            if (!projectId) {
                showMessage('error', 'プロジェクトを選択してください。');
                return;
            }
            if (!logContent) {
                showMessage('error', '記録するログ内容を入力してください。');
                return;
            }

            saveLogBtn.disabled = true;
            saveLogBtn.textContent = '記録中...';
            startProgress();

            try {
                const response = await fetch('/api/save-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId: parseInt(projectId), logContent })
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || '不明なエラーが発生しました。');
                }

                showMessage('success', 'ログをデータベースに記録しました！');
                logContentInput.value = ''; // 成功したらクリア

            } catch (error) {
                console.error('ログの保存に失敗:', error);
                showMessage('error', `ログの保存に失敗しました: ${error.message}`);
            } finally {
                saveLogBtn.disabled = false;
                saveLogBtn.textContent = '3. このログをDBに記録する';
                finishProgress();
            }
        });

        // --- 全ログ取得ボタン ---
        fetchAllLogsBtn.addEventListener('click', async () => {
            const projectId = projectSelector.value;
            if (!projectId) {
                showMessage('error', 'プロジェクトを選択してください。');
                return;
            }

            fetchAllLogsBtn.disabled = true;
            fetchAllLogsBtn.textContent = '取得中...';
            allLogsOutput.value = 'データベースから全ログを取得しています...';
            startProgress();

            try {
                const response = await fetch(`/api/get-all-logs?projectId=${projectId}`);
                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.status}`);
                }
                const allLogsText = await response.text();
                allLogsOutput.value = allLogsText || 'このプロジェクトにはまだログがありません。';

            } catch (error) {
                console.error('全ログの取得に失敗:', error);
                allLogsOutput.value = `全ログの取得に失敗しました: ${error.message}`;
                showMessage('error', `全ログの取得に失敗しました: ${error.message}`);
            } finally {
                fetchAllLogsBtn.disabled = false;
                fetchAllLogsBtn.textContent = '選択中プロジェクトの全ログを取得';
                finishProgress();
            }
        });

        // --- コピーボタン ---
        const setupCopyButton = (button, targetElement, successText) => {
            button.addEventListener('click', async () => {
                if (!targetElement.value) return;
                await navigator.clipboard.writeText(targetElement.value);
                const originalText = button.textContent;
                button.textContent = successText;
                setTimeout(() => { button.textContent = originalText; }, 2000);
            });
        };
        setupCopyButton(copyAllLogsBtn, allLogsOutput, 'コピーしました！');
        
        // --- アプリケーション起動 ---
        initializeProjects();
    });
    </script>
</body>
</html>